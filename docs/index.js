const CLIENT_ID="945330460050-osmelc2uen8vhdesa6kd55vvjivkm5vs.apps.googleusercontent.com",API_KEY="AIzaSyD_EbPMAwZ9EDHiLHqGToi7-31ZnwXHams",DISCOVERY_DOCS=["https://sheets.googleapis.com/$discovery/rest?version=v4"],SCOPES="https://www.googleapis.com/auth/drive.file",authorizeParts=document.getElementById("authorize"),authorizeButton=document.getElementById("authorize_button"),signoutButton=document.getElementById("signout_button");loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function init(){const a=localStorage.getItem("vocabee.spreadsheetId");a&&(document.getElementById("spreadsheetId").value=a),loadPlansFromIndexedDB(a=>{updatePlan(a)})}function updateSpreadsheetId(a){const b=a.target.value;localStorage.setItem("vocabee.spreadsheetId",b),loadPlansOrCreate()}function _handleClientLoad(){gapi.load("client:auth2",initClient)}function initClient(){gapi.client.init({apiKey:API_KEY,clientId:CLIENT_ID,discoveryDocs:DISCOVERY_DOCS,scope:SCOPES}).then(a=>{gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus),updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get()),authorizeButton.onclick=handleAuthClick,signoutButton.onclick=handleSignoutClick}).catch(a=>{console.log(a)})}function updateSigninStatus(a){a?(authorizeParts.style.display="none",signoutButton.style.display="inline-block",document.getElementById("signed").classList.remove("d-none"),loadPlansOrCreate()):(loadPlansFromIndexedDB(a=>{updatePlan(a)}),authorizeParts.style.display="inline-block",signoutButton.style.display="none")}function _renderButton(){gapi.signin2.render("authorize_button",{scope:"profile email",longtitle:!0,theme:"dark"})}function handleAuthClick(a){gapi.auth2.getAuthInstance().signIn()}function handleSignoutClick(a){gapi.auth2.getAuthInstance().signOut()}customElements.define("plan-box",class extends HTMLElement{constructor(){super();const a=document.getElementById("plan-box").content.cloneNode(!0);this.attachShadow({mode:"open"}).appendChild(a)}});function createSpreadsheet(){const a=gapi.client.sheets.spreadsheets.create({},{properties:{title:"Vocabee"},sheets:[{properties:{title:"index"}},{properties:{title:"words"}}]});a.then(b=>{const a=b.result.spreadsheetId;document.getElementById("spreadsheetId").value=a,localStorage.setItem("vocabee.spreadsheetId",a)},function(a){console.error("error: "+a.result.error.message)})}function getPlanRange(a){switch(!0){case a<=1800:return 200;case a<=2600:return 400;default:return 1e3}}function loadPlan(b,d,c){const a=document.getElementById("progress"+b);if(a){const e=getPlanRange(b);if(a.max=e,a.value=d,a.title=Math.ceil(c)+"%",95<=c){const b=a.parentNode.parentNode.firstChild;b.textContent="✔️"}}}function updatePlan(b){const c=document.getElementById("progresses"),d=c.getElementsByTagName("tr"),a=[...d].slice(1);if(b<5e3){const c=document.getElementById("progress5000").parentNode.parentNode,b=a.findIndex(a=>a==c);a.slice(0,b).forEach(a=>{a.classList.remove("d-none")}),a.slice(b+1).forEach(a=>{a.classList.add("d-none")})}else{const d=a.findIndex(a=>{const c=parseInt(a.children[1].textContent);if(b<c)return!0});a.slice(0,d-6).forEach(a=>{a.classList.add("d-none")});const e=a.slice(d);for(let a=0;a<=3-e.length;a++){const d=b+1e3*(e.length+a),f=document.getElementById("progress"+d);if(f){const a=f.parentNode.parentNode;a.classList.remove("d-none")}else{const a=createPlan(d-999,d);c.getElementsByTagName("tr")[0].parentNode.appendChild(a)}}}}function getAward(a){switch(!0){case a=200:return"小6";case a=400:return"中1";case a=600:return"中2";case a=800:return"中3";case a=1200:return"高1";case a=1600:return"高2";case a=2200:return"高3";case a=3e3:return"大学生";case a=5e3:return"社会人";case a=1e4:return"expatriater";case a=15e3:return"fighter";case a=2e4:return"knight";case a=25e3:return"interpreter";case a=3e4:return"native";case a=35e3:return"magician";case a=4e4:return"demon";default:return""}}function createPlan(d,a){const b=document.createElement("plan-box").shadowRoot,c=b.querySelector("a");c.href=`/vocabee/drill/?q=${d}-${a}`,c.textContent=a;const e=b.querySelector("progress");e.id="progress"+a;const f=b.querySelector("td:nth-child(3)");return f.textContent=getAward(a),b}function openDB(b){const a=indexedDB.open("vocabee");a.onsuccess=a=>b(a.target.result),a.onerror=()=>console.log("failed to open db"),a.onupgradeneeded=b=>{const a=b.target.result;a.createObjectStore("index",{keyPath:"level"});const c=a.createObjectStore("words",{keyPath:"lemma"});c.createIndex("level","level",{unique:!1})}}function putIndices(){const a=document.getElementById("progresses"),b=a.getElementsByTagName("tr"),c=[...b].slice(1),d=c.map(c=>{const b=c.children[5].firstChild,d=parseInt(b.id.slice(8));let a=parseInt(b.value);return a==0&&(a=void 0),[d,a]});d.forEach(a=>{const[b,c]=a;putIndex(b,c)})}function putIndex(b,c,a){openDB(f=>{const d="index",g={level:b,known:c},e=f.transaction(d,"readwrite").objectStore(d).put(g);e.onsuccess=b=>{a&&a(b)},e.onerror=()=>console.log("failed to put")})}function getIndex(a){return new Promise((e,f)=>{let c;const d="index",b=a.transaction(d,"readonly"),g=b.objectStore(d).getAll();b.oncomplete=()=>e(c),b.onerror=a=>f(a),g.onsuccess=a=>{c=a.target.result}})}function loadPlansFromIndexedDB(a){openDB(b=>{getIndex(b).then(c=>{let b=0;c.forEach(c=>{const a=c.level,d=c.known||0,e=getPlanRange(a),f=d*100/e||0;if(!document.getElementById("progress"+a)){const b=createPlan(a-e+1,a);progresses.appendChild(b)}loadPlan(a,d,f),95<=f&&b<a&&(b=a)}),a(b)})})}function loadPlansFromSheet(a){let b=0;if(a.values)for(let d=0;d<a.values.length;d++){const e=a.values[d],c=parseInt(e[0]),f=parseInt(e[1])||0,g=getPlanRange(c),h=f*100/g||0;if(!document.getElementById("progress"+c)){const a=createPlan(c-g+1,c);progresses.appendChild(a)}loadPlan(c,f,h),95<=h&&b<c&&(b=c)}return b}function loadPlansOrCreate(){const a=document.getElementById("spreadsheetId").value;a!=""?gapi.client.sheets.spreadsheets.values.get({spreadsheetId:a,range:"index!A1:B49"}).then(a=>{document.getElementById("spreadsheetIdError").classList.add("d-none");const b=loadPlansFromSheet(a.result);updatePlan(b),putIndices()}).catch(b=>{switch(b.status){case 400:addSheet(a,"index");break;case 404:document.getElementById("spreadsheetIdError").classList.remove("d-none");break;default:console.log(b)}}):createSpreadsheet()}function addSheet(b,c,a){return gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:b},{requests:[{addSheet:{properties:{title:c}}}]}).then(b=>{a&&a(b)}).catch(a=>{console.log(a)})}init(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("spreadsheetId").onchange=updateSpreadsheetId