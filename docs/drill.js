const CLIENT_ID="945330460050-osmelc2uen8vhdesa6kd55vvjivkm5vs.apps.googleusercontent.com",API_KEY="AIzaSyD_EbPMAwZ9EDHiLHqGToi7-31ZnwXHams",DISCOVERY_DOCS=["https://sheets.googleapis.com/$discovery/rest?version=v4"],SCOPES="https://www.googleapis.com/auth/drive.file";let level,enjaList=[],draggies=[],test1method,test2count=0,test2score=0,test2problems=[],englishVoices=[];loadVoices();let pendingPush,testLength=20;const maxTestLength=20,correctAudio=new Audio("/vocabee/mp3/correct3.mp3"),incorrectAudio=new Audio("/vocabee/mp3/incorrect1.mp3");loadConfig(),initFromIndexedDB();const carousel=new bootstrap.Carousel(document.getElementById("main"),{interval:!1,touch:!1}),modalNode=document.getElementById("modal"),modal=new bootstrap.Modal(modalNode);function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark"),localStorage.getItem("voice")!=1&&(document.getElementById("voiceOn").classList.add("d-none"),document.getElementById("voiceOff").classList.remove("d-none"))}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function toggleVoice(){speechSynthesis.cancel(),localStorage.getItem("voice")==1?(localStorage.setItem("voice",0),document.getElementById("voiceOn").classList.add("d-none"),document.getElementById("voiceOff").classList.remove("d-none")):(localStorage.setItem("voice",1),document.getElementById("voiceOn").classList.remove("d-none"),document.getElementById("voiceOff").classList.add("d-none"))}function loadVoices(){const a=new Promise(function(b){let a=speechSynthesis.getVoices();if(a.length!==0)b(a);else{let c=!1;speechSynthesis.addEventListener("voiceschanged",function(){c=!0,a=speechSynthesis.getVoices(),b(a)}),setTimeout(()=>{c||document.getElementById("noTTS").classList.remove("d-none")},1e3)}}),b=["com.apple.speech.synthesis.voice.Bahh","com.apple.speech.synthesis.voice.Albert","com.apple.speech.synthesis.voice.Hysterical","com.apple.speech.synthesis.voice.Organ","com.apple.speech.synthesis.voice.Cellos","com.apple.speech.synthesis.voice.Zarvox","com.apple.speech.synthesis.voice.Bells","com.apple.speech.synthesis.voice.Trinoids","com.apple.speech.synthesis.voice.Boing","com.apple.speech.synthesis.voice.Whisper","com.apple.speech.synthesis.voice.Deranged","com.apple.speech.synthesis.voice.GoodNews","com.apple.speech.synthesis.voice.BadNews","com.apple.speech.synthesis.voice.Bubbles"];a.then(a=>{englishVoices=a.filter(a=>a.lang=="en-US").filter(a=>!b.includes(a.voiceURI))})}function loopVoice(b,c){speechSynthesis.cancel();const a=new SpeechSynthesisUtterance(b);a.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],a.lang="en-US";for(let b=0;b<c;b++)speechSynthesis.speak(a)}function setLearningButton(c,b){const a=document.getElementById(c);a.textContent=b,b==0?a.parentNode.setAttribute("disabled",!0):a.parentNode.removeAttribute("disabled")}function loadEnjaListFromIndexedDB(a,b){openDB(d=>{const c={};getAllWords(d,a).then(d=>{d.forEach(a=>{c[a.lemma]=a.state}),enjaList=[],fetch("/vocabee/data/"+a+".tsv").then(a=>a.text()).then(a=>{a.split("\n").forEach(b=>{const[a,d]=b.split("	");enjaList.push([a,d,c[a]])}),b()})})})}function getPlanRange(a){switch(!0){case a<=1800:return 200;case a<=2600:return 400;default:return 1e3}}function loadPlans(c){const[a,b]=c,d=getPlanRange(level)-b-a;setLearningButton("known",b),setLearningButton("unlearned",a),setLearningButton("learning",d)}function loadProgresses(a){const b=[...document.getElementById("seqTest").children];b.forEach((b,d)=>{const[f,c]=a[d],e=Math.ceil(c/enjaList.length*1e3);b.max=enjaList.length/10,b.value=c,b.title=e+"%"})}function updatePlan(c,d){const a=document.getElementById(c);a.textContent=d;const b=a.parentNode;b.classList.add("animate__animated","animate__flipInY"),b.removeAttribute("disabled")}function updatePlans(a,b,c){const d=parseInt(document.getElementById("known").textContent),e=parseInt(document.getElementById("unlearned").textContent),f=parseInt(document.getElementById("learning").textContent),g=d+a,h=e+b,i=f+c;updatePlan("known",g),updatePlan("unlearned",h),updatePlan("learning",i)}function openDB(b){const a=indexedDB.open("vocabee");a.onsuccess=a=>b(a.target.result),a.onerror=()=>console.log("failed to open db"),a.onupgradeneeded=b=>{const a=b.target.result;a.createObjectStore("index",{keyPath:"level"});const c=a.createObjectStore("words",{keyPath:"lemma"});c.createIndex("level","level",{unique:!1})}}function getAllWords(a,b){return new Promise((f,g)=>{let d;const e="words",c=a.transaction(e,"readonly"),h=c.objectStore(e).index("level").getAll(b);c.oncomplete=()=>f(d),c.onerror=a=>g(a),h.onsuccess=a=>{d=a.target.result}})}function getWordState(a,b){return new Promise((f,g)=>{let d;const e="words",c=a.transaction(e,"readonly"),h=c.objectStore(e).get(b);c.oncomplete=()=>f(d),c.onerror=a=>g(a),h.onsuccess=b=>{const a=b.target.result;a?d=a.state:void 0}})}function putIndex(a){openDB(e=>{const b="index";let c=0;enjaList.forEach(a=>{a[2]&&a[2].slice(-1)=="o"&&(c+=1)});const f={level,known:c},d=e.transaction(b,"readwrite").objectStore(b).put(f);d.onsuccess=b=>{a&&a(b)},d.onerror=()=>console.log("failed to put")})}function putWordState(g,d,e,b){const c="words",f={lemma:d,level,state:e},a=g.transaction(c,"readwrite").objectStore(c).put(f);a.onsuccess=a=>{b&&b(a)},a.onerror=()=>console.log("failed to put")}function putWord(a,b){openDB(c=>{getWordState(c,a).then(d=>{d?d+=b:d=b,putWordState(c,a,d)})})}function putWords(){openDB(a=>{enjaList.forEach(b=>{const c=b[0],d=b[2];putWordState(a,c,d)})})}function putWordsBase(d,a){const e=[...document.getElementById(d).lastElementChild.children],b=e.map(a=>a.textContent),c=b.map(a=>enjaList.findIndex(b=>b[0]==a));return b.forEach((b,d)=>{updateEnjaListState(c[d],a),putWord(b,a)}),c}function putWordsFromTest1(){const a=putWordsBase("test1known","o"),b=putWordsBase("test1learning","x");return updateProgresses(a,1),[a.length,b.length]}function updateEnjaListState(a,b){const c=enjaList[a][2];c?enjaList[a][2]+=b:enjaList[a][2]=b}function updateProgresses(d,b){const a={},e=[...document.getElementById("seqTest").children];d.forEach(d=>{const c=Math.floor(d/(enjaList.length/10));c in a?a[c]+=b:a[c]=b});let c=0;for(const[g,d]of Object.entries(a)){const h=parseInt(g),b=e[h],f=parseInt(b.value)+d,i=parseInt(b.max);b.value=f,b.title=Math.ceil(f/i*100)+"%",b.classList.add("animate__animated","animate__bounceInLeft"),c+=d}return c}function updateProgress(c,d){const e=[...document.getElementById("seqTest").children],f=Math.floor(c/(enjaList.length/10)),a=e[f],b=parseInt(a.value)+d,g=parseInt(a.max);a.value=b,a.title=Math.ceil(b/g*100)+"%",a.classList.add("animate__animated","animate__bounceInLeft")}function updateViewByKnown(){putWordsBase("test1known","o");const b=putWordsBase("test1learning","x"),a=updateProgresses(b,-1);updatePlans(a,0,-a)}function updateViewByLearning(){const b=putWordsBase("test1known","o");putWordsBase("test1learning","x");const a=updateProgresses(b,1);updatePlans(a,0,-a)}function test1moveTop(){switch(draggies.forEach(a=>{a.destroy()}),draggies=[],test1method){case"known":{updateViewByKnown();break}case"unlearned":{const[a,b]=putWordsFromTest1();updatePlans(a,-a-b,b);break}case"learning":{updateViewByLearning();break}}navigator.onLine?(pushWords(),pushIndex()):pendingPush=!0,putIndex(),moveTop()}function searchByGoogle(c){c.preventDefault();const a=document.getElementById("cse-search-input-box-id");document.getElementById("___gcse_0").classList.remove("d-none");const b=google.search.cse.element.getElement("searchresults-only0");a.value==""?b.clearAllResults():b.execute(a.value)}document.getElementById("cse-search-box-form-id").onsubmit=searchByGoogle;function search(){const b=this.id.slice(6),a=document.getElementById("modal-title").textContent;switch(b){case"Google":window.open(`https://www.google.com/search?q=${a}+意味`);return;case"Eijiro":window.open(`https://eow.alc.co.jp/search?q=${a}`);return;case"Weblio1":window.open(`https://ejje.weblio.jp/content/${a}`);return;case"Weblio2":window.open(`https://ejje.weblio.jp/sentence/content/${a}`);return;case"ReversoContext":window.open(`https://context.reverso.net/翻訳/英語-日本語/${a}`);return}}function addDragEvent(a,c,d){const e=document.getElementById("test1known"),f=document.getElementById("test1learning"),g=document.getElementById("dragZone"),b=new Draggabilly(a);d||(a.textContent=c[0],a.classList.add("btn-lg")),b.on("staticClick",function(){document.getElementById("meaning").textContent=c[1].split("|").join(", "),document.getElementById("modal-title").textContent=c[0],modal.toggle("toggle")}),b.on("dragStart",function(e,f){const c=a.getBoundingClientRect();document.body.appendChild(a);const d=a.getBoundingClientRect();b.setPosition(c.left-d.left,c.top-d.top)}),b.on("dragEnd",function(d,h){if(a.removeAttribute("style"),a.classList.remove("btn-lg"),b.position.y<0){const b=e.lastElementChild;b.insertBefore(a,b.firstElementChild)}else{const b=f.lastElementChild;b.insertBefore(a,b.firstElementChild)}draggies=draggies.filter(a=>a!=b),b.destroy(),addDragEvent(a,c,!0),g.children.length==0&&document.getElementById("test1moveTop").classList.remove("d-none")}),draggies.push(b)}function getRandomInt(a){return Math.floor(Math.random()*a)}function setProblems(b,c){test1method=b;const a=getTargetStateProblems(c),d=document.getElementById("dragZone"),e=[...d.children],f=document.getElementById("test1noneed");e.forEach((b,c)=>{c>=a.length?f.appendChild(b):addDragEvent(b,a[c])})}function getTargetStateProblems(b){const a=[];return enjaList.some(c=>{if(c[2]&&c[2].slice(-1)==b)if(a.push(c),a.length>=maxTestLength)return!0}),a}function getUnlearnedProblems(){const a=[];return enjaList.some(b=>{if(!b[2])if(a.push(b),a.length>=maxTestLength)return!0}),a}function setUnlearnedProblems(){test1method="unlearned";const a=getUnlearnedProblems(),b=document.getElementById("dragZone"),c=document.getElementById("test1noneed");[...b.children].forEach((b,d)=>{d>=a.length?c.appendChild(b):addDragEvent(b,a[d])})}function moveTop(){carousel.to(0)}function test1cleanup(){document.getElementById("test1moveTop").classList.add("d-none");const a=document.getElementById("dragZone"),b=document.getElementById("test1known"),c=document.getElementById("test1learning"),d=document.getElementById("test1noneed"),e=[...b.lastElementChild.children].concat([...c.lastElementChild.children]).concat([...d.children]);e.forEach(b=>{a.appendChild(b)}),carousel.to(1)}function test1(a){switch(test1cleanup(),a){case"known":return setProblems("known","o");case"unlearned":return setUnlearnedProblems();case"learning":return setProblems("learning","x")}}class Choice{constructor(a,b,c,d){this.en=a,this.ja=b,this.desc=c,this.isAnswer=d}}function test2selectAnswers(b,c){const a=enjaList.concat();switch(b){case"all":return shuffle(a),a.slice(0,maxTestLength);case"learning":{const b=a.filter(a=>a[2]&&a[2].slice(-1)=="x");return b.length<maxTestLength?b:b.slice(0,maxTestLength)}default:{const b=a.length/10,d=b*c,e=a.slice(d,d+b);return shuffle(e).slice(0,maxTestLength)}}}function test2generateProblems(c,d){const a=test2selectAnswers(c,d);testLength=a.length;const b=[];return a.forEach(a=>{const c=test2generateChoices(a);b.push(c)}),b}function generateChoice(a,c){const b=a[1].split("|");shuffle(b);const d=b.slice(0,3).join(", "),[e,f]=a;return new Choice(e,d,f.split("|"),c)}function test2generateChoices(b){const a=[generateChoice(b,!0)];while(a.length!=4){const c=enjaList[getRandomInt(enjaList.length)];if(c[0]!=b[0]){const b=generateChoice(c,!1);a.every(a=>!a.desc.includes(b.ja))&&a.push(b)}}return a}function shuffle(a){let b=a.length,d,c;while(0!==b)c=Math.floor(Math.random()*b),b-=1,d=a[b],a[b]=a[c],a[c]=d;return a}function test2setButtons(c,a,b){c?(document.getElementById("test2lemma").textContent=b[0].en,loopVoice(b[0].en,3)):document.getElementById("test2lemma").textContent=b[0].ja,shuffle(b).forEach((d,b)=>{a[b].classList.remove("text-danger"),c?a[b].textContent=d.ja:a[b].textContent=d.en,d.isAnswer?a[b].setAttribute("data-answer","true"):a[b].removeAttribute("data-answer")})}function test2getTrs(){const a=[...document.getElementById("test2table1").getElementsByTagName("tr")],b=[...document.getElementById("test2table2").getElementsByTagName("tr")];return a.concat(b)}function test2setResult(c,b){const d=test2getTrs(),e=d[c-1],a=e.children;a[0].firstChild.textContent="🔊",a[1].textContent=b[0].en,a[2].textContent=b[0].desc}function test2cleanResult(){const a=test2getTrs();a.forEach(b=>{const a=b.children;a[0].firstChild.textContent="",a[1].textContent="",a[2].textContent=""})}function test2all(){test2base("all")}function test2learning(){test2base("learning")}function test2seq(){const a=[...document.getElementById("seqTest").children],b=a.findIndex(a=>a==this);test2base("seq",b)}function test2base(b,c){const d=test2getTrs();d.forEach(a=>{a.classList.remove("table-danger")}),test2problems=test2generateProblems(b,c),test2count=1,test2score=0;const e=[...document.getElementById("choices").children],a=document.getElementById("testType1").checked;test2cleanResult(),test2setResult(test2count,test2problems[0]),test2setButtons(a,e,test2problems[0]),a?document.getElementById("test2voice").classList.remove("d-none"):document.getElementById("test2voice").classList.add("d-none"),carousel.to(2)}function test2countScore(){const a=[...document.getElementById("choices").children];return a.every(a=>!a.classList.contains("text-danger"))}function test2moveTop(){navigator.onLine?(pushWords(),pushIndex()):pendingPush=!0,putIndex(),moveTop()}function test2put(g,h){const b=enjaList.findIndex(a=>a[0]==g);let a=enjaList[b][2],c,e=0,f=0,d=0;h?(c="o",updateEnjaListState(b,c),a?a.slice(-1)=="x"&&(d-=1,e+=1,updateProgress(b,1)):(f-=1,e+=1,updateProgress(b,1))):(c="x",updateEnjaListState(b,c),a?a.slice(-1)=="o"&&(e-=1,d+=1,updateProgress(b,-1)):(f-=1,d+=1)),openDB(b=>{a?a+=c:a=c,putWordState(b,g,a),updatePlans(e,f,d)})}function test2select(){const a=[...document.getElementById("choices").children],b=test2problems[test2count-1],c=document.getElementById("testType1").checked;if(this.dataset.answer){test2count+=1;const d=test2countScore();test2score+=d,correctAudio.play(),this.textContent="⭕ "+this.textContent;const e=b.find(a=>a.isAnswer).en;if(test2put(e,d),test2count>testLength)document.getElementById("score").textContent=test2score,document.getElementById("testLength").textContent=testLength,carousel.to(3);else{const b=test2problems[test2count-1];test2setResult(test2count,b),test2setButtons(c,a,b)}}else{speechSynthesis.cancel(),incorrectAudio.play();const d=a.findIndex(a=>a==this),c=b[d];this.textContent=c.en+": "+c.ja,this.classList.add("text-danger");const e=test2getTrs();e[test2count-1].classList.add("table-danger")}}function countupStates(){const a=[0,0],b=[...Array(10)].map(()=>Array(2).fill(0));return enjaList.forEach(e=>{const[f,h,c]=e,g=enjaList.findIndex(a=>a[0]==f),d=Math.floor(g/(enjaList.length/10));c?c.slice(-1)=="o"&&(a[1]+=1,b[d][1]+=1):(a[0]+=1,b[d][0]+=1)}),[a,b]}function initProblemRange(){let b,a;const c=new URLSearchParams(location.search);return c.has("q")?([b,a]=c.get("q").split("-"),b=parseInt(b),a=parseInt(a),level=a):(b=1,a=200,level=200),document.getElementById("levelText").textContent=getAward(level),document.getElementById("levelFrom").textContent=b,document.getElementById("levelTo").textContent=a,[b,a]}function initFromIndexedDB(){initProblemRange(),loadEnjaListFromIndexedDB(level,()=>{const[a,b]=countupStates();loadPlans(a),loadProgresses(b)})}function _handleClientLoad(){gapi.load("client:auth2",initClient)}function initClient(){gapi.client.init({apiKey:API_KEY,clientId:CLIENT_ID,discoveryDocs:DISCOVERY_DOCS,scope:SCOPES}).then(a=>{gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus),updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get())}).catch(a=>{console.log(a)})}function updateSigninStatus(a){a&&(initSheet(),document.getElementById("signed").classList.remove("d-none"))}function getAward(a){switch(!0){case a<=200:return"小6";case a<=400:return"中1";case a<=600:return"中2";case a<=1e3:return"中3";case a<=1400:return"高1";case a<=1800:return"高2";case a<=2600:return"高3";case a<=4e3:return"大学生";case a<=9e3:return"社会人";case a<=1e4:return"expatriater";case a<=15e3:return"fighter";case a<=2e4:return"knight";case a<=25e3:return"interpreter";case a<=3e4:return"native";case a<=35e3:return"magician";case a<=4e4:return"demon";default:return"god"}}function initFromSheet(a){loadEnjaListFromSheet(a,()=>{const[a,b]=countupStates();loadPlans(a),loadProgresses(b),putWords()}),setAutoReload()}let reloadedTime,reloadCheckedTime;function setAutoReload(){reloadedTime=Date.now(),reloadCheckedTime=Date.now(),setInterval(function(){const a=Date.now();reloadedTime+33e5<a?reloadCheckedTime+33e5?location.reload():(gapi.auth2.getAuthInstance().currentUser.get().reloadAuthResponse(),reloadedTime=Date.now()):reloadCheckedTime=Date.now(),navigator.onLine?(document.getElementById("signed").classList.remove("d-none"),pendingPush&&(pushWords(),pushIndex())):document.getElementById("signed").classList.add("d-none")},1e3)}function loadEnjaListFromSheet(a,c){const b={};if(a.values)for(let c=0;c<a.values.length;c++){const d=a.values[c],e=d[0],f=d[1];b[e]=f}return fetch("/vocabee/data/"+level+".tsv").then(a=>a.text()).then(a=>{enjaList=[],a.split("\n").forEach(c=>{const[a,d]=c.split("	");enjaList.push([a,d,b[a]])}),c()})}function getSheetPos(a){switch(!0){case a<=1600:return a/200;case a<=2600:return(a-1800)/400+9;default:return(a-3e3)/1e3+12}}function pushIndex(){const b=localStorage.getItem("vocabee.spreadsheetId"),c=getSheetPos(level);let a=0;enjaList.forEach(b=>{b[2]&&b[2].slice(-1)=="o"&&(a+=1)}),gapi.client.sheets.spreadsheets.values.update({spreadsheetId:b,range:`index!A${c}`,valueInputOption:"RAW",values:[[level,a]]}).then(a=>{pendingPush=!1}).catch(a=>{pendingPush=!0})}function pushWords(){const a=localStorage.getItem("vocabee.spreadsheetId"),b=document.getElementById("levelFrom").textContent,c=document.getElementById("levelTo").textContent,d=enjaList.map(a=>[a[0],a[2]]);gapi.client.sheets.spreadsheets.values.update({spreadsheetId:a,range:`words!A${b}:B${c}`,valueInputOption:"RAW",values:d}).then(a=>{pendingPush=!1}).catch(a=>{pendingPush=!0})}function initSheet(){const a=localStorage.getItem("vocabee.spreadsheetId"),[b,c]=initProblemRange();a&&gapi.client.sheets.spreadsheets.values.get({spreadsheetId:a,range:`words!A${b}:B${c}`}).then(a=>(document.getElementById("spreadsheetIdError").classList.add("d-none"),initFromSheet(a.result))).catch(b=>{switch(b.status){case 400:addSheet(a,"words");break;case 404:document.getElementById("spreadsheetIdError").classList.remove("d-none");break;default:console.log(b)}})}function addSheet(b,c,a){return gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:b},{requests:[{addSheet:{properties:{title:c}}}]}).then(b=>{a&&a(response)}).catch(a=>{console.log(a)})}document.getElementById("voice").onclick=toggleVoice,document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("test1moveTop").onclick=test1moveTop,document.getElementById("searchGoogle").onclick=search,document.getElementById("searchEijiro").onclick=search,document.getElementById("searchWeblio1").onclick=search,document.getElementById("searchWeblio2").onclick=search,document.getElementById("searchReversoContext").onclick=search,document.getElementById("knownButton").onclick=function(){test1("known")},document.getElementById("unlearnedButton").onclick=function(){test1("unlearned")},document.getElementById("learningButton").onclick=function(){test1("learning")},document.getElementById("test2moveTop").onclick=test2moveTop,document.getElementById("test2all").onclick=test2all,document.getElementById("test2learning").onclick=test2learning,[...document.getElementsByClassName("moveTop")].forEach(a=>{a.onclick=moveTop}),[...document.getElementById("choices").children].forEach(a=>{a.onclick=test2select}),[...document.getElementById("seqTest").children].forEach(a=>{a.onclick=test2seq}),modalNode.addEventListener("shown.bs.modal",function(){const b=document.getElementById("modal-voice"),a=b.previousElementSibling.textContent;document.getElementById("cse-search-input-box-id").value=a,document.getElementById("___gcse_0").classList.add("d-none"),localStorage.getItem("voice")!=0&&loopVoice(a,3)}),document.getElementById("test2voice").onclick=function(){const a=this.previousElementSibling.textContent;loopVoice(a,3)},document.getElementById("modal-voice").onclick=function(a){const b=a.target.previousElementSibling.textContent;loopVoice(b,3)},test2getTrs().forEach(b=>{const a=b.children,c=a[0].firstChild;c.onclick=function(){loopVoice(a[1].textContent,1)}})